@model ProyectoFinal4.ViewModels.MiPerfilViewModel
@{
    ViewData["Title"] = "Mi Perfil";
}

@section Styles {
    <link rel="stylesheet" href="~/css/pages/Usuario/miPerfil.css" asp-append-version="true" />
}

<!-- Fondo -->
<img alt="Dark cinema background" class="bg-image"
     src="https://lh3.googleusercontent.com/aida-public/AB6AXuDkRMedjlKp4o-qzUnqkCj8kfS59o9yIbUkHUDddb6yd2BoUekcPtZCQ6FE_inZ3i4H0Q3WJ7JfBi5JQhFhhEmwoEejlfna2nP3R8YBkXmOmTLVQ_fokIPIwy2qLO4ekioonw5WWoPsffJb4CyZlac8B8uR-TVPNVdyYzjcucItl-7AmMj3oLL3MGH5T1eabckYKU6ygCt0HnLxtInWjeDjrRHy3zu-71IKa7TzWO6vXY2NeDDSrQ-aah0ES8xYwOQJIrG8VzOMaMp9" />

<div class="bg-overlay"></div>
<div class="bg-shape-tl"></div>
<div class="bg-shape-tr-1"></div>
<div class="bg-shape-tr-2"></div>
<div class="bg-shape-br"></div>
<div class="bg-shape-br-inner"></div>

<div class="container py-4 py-lg-5 profile-page">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-6 col-xl-5">

            <div class="glass-card p-4 p-md-5 w-100">

                <!-- Header -->
                <div class="text-center mb-4">
                    <div class="position-relative d-inline-block mb-3">
                        <img alt="Profile Avatar"
                             class="avatar-img"
                             src="" />

                        <!-- Botón editar imagen -->
                        <button aria-label="Editar foto de perfil"
                                class="btn-edit-avatar"
                                type="button"
                                onclick="document.getElementById('AvatarFile')?.click()">
                            <span class="material-symbols-outlined" style="font-size: 18px;">photo_camera</span>
                        </button>
                    </div>

                    <h1 class="h3 fw-bold mb-1 text-white">Mi Perfil</h1>
                    <p class="text-white-dim small mb-0">Gestioná tu información personal</p>
                </div>

                <form asp-controller="Usuario" asp-action="MiPerfil" method="post" novalidate>

                    @Html.AntiForgeryToken()

                    <!-- Input oculto para foto -->
                    <input  id="AvatarFile" type="file" class="d-none" accept="image/*" />

                    <span class="section-title">Información personal</span>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <div class="custom-input-group">
                                <div class="input-icon">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">person</span>
                                </div>
                                <input 
                                       asp-for="Nombre"
                                       
                                       class="form-control"
                                       placeholder="Nombre"
                                       type="text" />
                            </div>
                            <span  class="validation-msg"></span>
                        </div>

                        <div class="col-6">
                            <div class="custom-input-group">
                                <div class="input-icon">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">badge</span>
                                </div>
                                <input 
                                       asp-for="Apellido"
                                       
                                       class="form-control"
                                       placeholder="Apellido"
                                       type="text" />
                            </div>
                            <span  class="validation-msg"></span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="custom-input-group disabled">
                            <div class="input-icon">
                                <span class="material-symbols-outlined" style="font-size: 20px;">mail</span>
                            </div>

                            <input 
                                   asp-for="Email"
                                   
                                   class="form-control"
                                   placeholder="Correo electrónico"
                                   type="email"
                                   disabled />
                        </div>

                        <div class="form-text text-white-dim ms-3 hint-email">
                            El correo electrónico no se puede modificar.
                        </div>
                    </div>

                    <!-- Guardar cambios personales -->
                    <div class="d-grid mb-5">
                        <button class="btn-gold shadow-sm w-100" type="submit" name="action" value="SaveProfile">
                            <span>Guardar cambios</span>
                        </button>
                    </div>
                </form>
                    @if (ViewBag.Mensaje != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @ViewBag.Mensaje
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="alert"
                                    aria-label="Close">
                            </button>
                        </div>
                    }
                    <!-- Seguridad -->
                    <div class="border-top border-secondary pt-4 mb-2">
                        <span class="section-title mb-3">Seguridad</span>

                        <div class="d-grid mb-3">
                            <button class="btn-gold-outline w-100"
                                    type="button"
                                    onclick="togglePasswordBlock()">
                                Actualizar contraseña
                            </button>
                        </div>

                        <div class="d-none" id="security-form-block">

                            <!-- Contraseña actual -->
                            <div class="mb-3">
                                <div class="custom-input-group">
                                    <div class="input-icon">
                                        <span class="material-symbols-outlined">lock</span>
                                    </div>

                                    <input 
                                           id="CurrentPassword"
                                           class="form-control"
                                           placeholder="Contraseña actual"
                                           type="password" />

                                    <button class="toggle-password"
                                            type="button"
                                            onclick="toggleVisibility('CurrentPassword', this)">
                                        <span class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                                <span  class="validation-msg"></span>
                            </div>

                            <!-- Nueva contraseña -->
                            <div class="mb-3">
                                <div class="custom-input-group">
                                    <div class="input-icon">
                                        <span class="material-symbols-outlined">lock_reset</span>
                                    </div>

                                    <input 
                                           id="NewPassword"
                                           class="form-control"
                                           placeholder="Nueva contraseña"
                                           type="password" />

                                    <button class="toggle-password"
                                            type="button"
                                            onclick="toggleVisibility('NewPassword', this)">
                                        <span class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                                <span  class="validation-msg"></span>
                            </div>

                            <!-- Repetir nueva contraseña -->
                            <div class="mb-3">
                                <div class="custom-input-group">
                                    <div class="input-icon">
                                        <span class="material-symbols-outlined">lock_reset</span>
                                    </div>

                                    <input 
                                           id="ConfirmNewPassword"
                                           class="form-control"
                                           placeholder="Repetir nueva contraseña"
                                           type="password" />

                                    <button class="toggle-password"
                                            type="button"
                                            onclick="toggleVisibility('ConfirmNewPassword', this)">
                                        <span class="material-symbols-outlined">visibility_off</span>
                                    </button>
                                </div>
                                <span  class="validation-msg"></span>
                            </div>

                            <!-- Botones: Guardar + Cancelar -->
                            <div class="d-grid mt-4">
                                <div class="d-flex gap-2">
                                    <button class="btn-gold shadow-sm flex-fill"
                                            type="submit"
                                            name="action"
                                            value="ChangePassword">
                                        <span>Guardar nueva contraseña</span>
                                    </button>

                                    <button class="btn-cancel flex-fill"
                                            type="button"
                                            onclick="cancelPasswordChange()">
                                        <span>Cancelar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                
            </div>

            <div class="text-center mt-4 w-100">
                <a class="text-white-dim text-decoration-none small" asp-action="Index" asp-controller="Home">
                    <span class="material-symbols-outlined align-middle me-1" style="font-size: 16px;">arrow_back</span>
                    Volver al inicio
                </a>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function togglePasswordBlock() {
            document.getElementById('security-form-block').classList.toggle('d-none');
        }

        function toggleVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('.material-symbols-outlined');

            if (input.type === "password") {
                input.type = "text";
                icon.textContent = "visibility";
            } else {
                input.type = "password";
                icon.textContent = "visibility_off";
            }
        }

        function cancelPasswordChange() {
            const block = document.getElementById('security-form-block');
            const ids = ['CurrentPassword', 'NewPassword', 'ConfirmNewPassword'];

            // limpiar inputs y volver a password
            ids.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = '';
                    input.type = 'password';
                }
            });

            // resetear iconos a visibility_off
            ids.forEach(id => {
                const input = document.getElementById(id);
                if (!input) return;

                const group = input.closest('.custom-input-group');
                if (!group) return;

                const icon = group.querySelector('.toggle-password .material-symbols-outlined');
                if (icon) icon.textContent = 'visibility_off';
            });

            // ocultar bloque
            block.classList.add('d-none');
        }
    </script>
}